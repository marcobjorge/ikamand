<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>iKamand</title>
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
  </head>
  <body>
    <nav class="navbar bg-body-tertiary">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="/images/favicon.png" alt="iKamand" width="30" height="24">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
              <a class="nav-link active" aria-current="page" href="#" id="clearHistory">Clear History</a>
            </li>
            <li class="nav-item" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
              <a class="nav-link active" aria-current="page" href="#" data-bs-toggle="modal" data-bs-target="#configModal">Configure</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 gx-5">
        <div class="col" id="configStatus">
          <a class="nav-link active" href="#">
            <div class="d-flex flex-row justify-content-center">
              <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayStatus" class="display-1" style="display:inline;">-</h1></div>
            </div>
            <div class="d-flex flex-row text-nowrap justify-content-center"><p>status</p></div>
          </a>
        </div>
        <div class="col">
          <div class="d-flex flex-row justify-content-center">
            <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayFanSpeed" class="display-1" style="display:inline;">-</h1></div>
            <div class="d-flex d-inline-flex align-items-end p-0"><p>%</p></div>
          </div>
          <div class="d-flex flex-row text-nowrap justify-content-center"><p>fan speed</p></div>
        </div>
        <div class="col">
          <div class="d-flex flex-row justify-content-center">
            <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayCurrentPitTemperature" class="display-1" style="display:inline;">-</h1></div>
            <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
          </div>
          <div class="d-flex flex-row text-nowrap justify-content-center"><p>current pit temp</p></div>
        </div>
        <div class="col" data-bs-toggle="modal" data-bs-target="#targetPitTemperatureModal">
          <a class="nav-link active" href="#">
            <div class="d-flex flex-row justify-content-center">
              <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayTargetPitTemperature" class="display-1" style="display:inline;">-</h1></div>
              <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
            </div>
            <div class="d-flex flex-row text-nowrap justify-content-center"><p>target pit temp</p></div>
          </a>
        </div>
        <div class="col" style="display:none;" id="displayProbe1Group">
          <div class="d-flex flex-row justify-content-center">
            <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayProbe1Temperature" class="display-1" style="display:inline;">-</h1></div>
            <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
          </div>
          <div class="d-flex flex-row text-nowrap justify-content-center"><p>probe 1 temp</p></div>
        </div>
        <div class="col" style="display:none;" id="displayProbe2Group">
          <div class="d-flex flex-row justify-content-center">
            <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayProbe2Temperature" class="display-1" style="display:inline;">-</h1></div>
            <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
          </div>
          <div class="d-flex flex-row text-nowrap justify-content-center"><p>probe 2 temp</p></div>
        </div>
        <div class="col" style="display:none;" id="displayProbe3Group">
          <div class="d-flex flex-row justify-content-center">
            <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayProbe3Temperature" class="display-1" style="display:inline;">-</h1></div>
            <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
          </div>
          <div class="d-flex flex-row text-nowrap justify-content-center"><p>probe 3 temp</p></div>
        </div>
        <div class="col" style="display:none;" data-bs-toggle="modal" data-bs-target="#targetFoodTemperatureModal" id="displayTargetFoodTemperatureGroup">
          <a class="nav-link active" href="#">
            <div class="d-flex flex-row justify-content-center">
              <div class="d-flex d-inline-flex align-items-end p-0"><h1 id="displayTargetFoodTemperature" class="display-1" style="display:inline;">-</h1></div>
              <div class="d-flex d-inline-flex align-items-end p-0"><p class="display-temperature-unit"></p></div>
            </div>
            <div class="d-flex flex-row text-nowrap justify-content-center"><p>target food temp</p></div>
          </a>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <canvas style="display:none;" id="pitTemperatureChart"></canvas>
          <canvas style="display:none;" id="foodTemperatureChart"></canvas>
        </div>
      </div>
    </div>

<div class="modal fade" id="targetFoodTemperatureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Target Food Temperature</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body container">
        <form>
          <div class="row">
            <div class="col-lg">
              <input type="range" min="0" max="400" step="5" class="form-range" id="configTargetFoodTemperatureRange" onInput="$('#configTargetFoodTemperatureVal').html($('#configTargetFoodTemperatureRange').val())">
            </div>
            <div class="col-sm-auto">
              <h1 id="configTargetFoodTemperatureVal"></h1>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        <button id="targetFoodTemperatureSave" type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="targetPitTemperatureModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Target Pit Temperature</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body container">
        <form>
          <div class="row">
            <div class="col-md">
              <input type="range" min="0" max="400" step="5" class="form-range" id="configTargetPitTemperatureRange" onInput="$('#configTargetPitTemperatureVal').html($('#configTargetPitTemperatureRange').val())">
            </div>
            <div class="col-sm-auto">
              <h1 id="configTargetPitTemperatureVal"></h1>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        <button id="targetPitTemperatureSave" type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="configModal" role="dialog" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configure</h5>
      </div>
      <div class="modal-body container">
        <form>
          <div class="row mb-3">
            <div class="row">
              <div class="col text-nowrap"><label for="refreshPeriodRange" class="form-label">Refresh Period (seconds)</label></div>
              <div class="col d-flex justify-content-end"><span id="refreshPeriodVal">-</span></div>
            </div>
            <div class="row">
              <div class="col"><input type="range" min="2" max="60" step="1" class="form-range" id="refreshPeriodRange" onInput="$('#refreshPeriodVal').html($('#refreshPeriodRange').val())"></div>
            </div>
          </div>
          <div class="row">
            <div class="col-md">
              <div class="col text-nowrap"><label class="form-label">Temperature Unit</label></div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="configTemperatureUnitCelsius">
                  <label class="form-check-label" for="configTemperatureUnitCelsius">
                    Celsius
                  </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="configTemperatureUnitFahrenheit">
                  <label class="form-check-label" for="configTemperatureUnitFahrenheit">
                    Fahrenheit
                  </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
        <button type="button" class="btn btn-primary" id="configSave">Save</button>
      </div>
    </div>
  </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
      const chart = (function(){
        var pitTemperatureChart = undefined;
        var foodTemperatureChart = undefined;

        const getPitTemperatureData = function(){
          var historicalData = ikamand.getHistoricalData();
          var historicalDataKeys = Object.keys(historicalData);

          return {
            datasets: [{
              label: 'current pit temp',
              backgroundColor: 'rgba(212,199,178, .1)',
              borderColor: 'rgba(212,199,178, .8)',
              data: historicalDataKeys.map(k => { return {x: new Number(k), y: historicalData[k].currentPitTemperature} }).filter(p => p.y != 400).map(p => {return {x: p.x, y: display.convertToTemperatureUnit(p.y)}}),
            },{
              label: 'target pit temp',
              backgroundColor: 'rgba(220,238,180, .0)',
              borderColor: 'rgba(220,238,180, .8)',
              data: historicalDataKeys.map(k => { return {x: new Number(k), y: historicalData[k].targetPitTemperature} }).filter(p => p.y != 400).map(p => {return {x: p.x, y: display.convertToTemperatureUnit(p.y)}}),
            }]
          }
        };

        const getFoodTemperatureData = function(probe1HasData, probe2HasData, probe3HasData){
          var historicalData = ikamand.getHistoricalData();
          var historicalDataKeys = Object.keys(historicalData);

          var datasets=[];
          if(probe1HasData){
            datasets.push({
              label: 'probe 1 temp',
              backgroundColor: 'rgba(221,221,221, .1)',
              borderColor: 'rgba(221,221,221, .8)',
              data: historicalDataKeys.map(k => { return {x: new Number(k), y: historicalData[k].probe1Temperature} }).filter(p => p.y != 400).map(p => {return {x: p.x, y: display.convertToTemperatureUnit(p.y)}}),
            });
          }
          if(probe2HasData){
            datasets.push({
              label: 'probe 2 temp',
              backgroundColor: 'rgba(255,230,181, .1)',
              borderColor: 'rgba(255,230,181, .8)',
              data: historicalDataKeys.map(k => { return {x: new Number(k), y: historicalData[k].probe2Temperature} }).filter(p => p.y != 400).map(p => {return {x: p.x, y: display.convertToTemperatureUnit(p.y)}}),
            });
          }
          if(probe3HasData){
            datasets.push({
              label: 'probe 3 temp',
              backgroundColor: 'rgba(212,255,207, .1)',
              borderColor: 'rgba(212,255,207, .8)',
              data: historicalDataKeys.map(k => { return {x: new Number(k), y: historicalData[k].probe3Temperature} }).filter(p => p.y != 400).map(p => {return {x: p.x, y: display.convertToTemperatureUnit(p.y)}}),
            });
          }
          datasets.push({
            label: 'target food temp',
            backgroundColor: 'rgba(253,173,158, .0)',
            borderColor: 'rgba(253,173,158, .8)',
            data: historicalDataKeys.map(k => { return {x: new Number(k), y: display.convertToTemperatureUnit(config.getTargetFoodTemperature() ?? config.getDefaultTargetFoodTemperature())}}),
          });

          return {
            datasets,
          }
        };

        return {
          refresh: function(){
            var historicalData = ikamand.getHistoricalData();
            var historicalDataKeys = Object.keys(historicalData);

            var pitTemperatureHasData = historicalDataKeys.filter(d => historicalData[d].currentPitTemperature != 400).length > 0;
            if( pitTemperatureHasData ){
              pitTemperatureChart.data = getPitTemperatureData();
              pitTemperatureChart.update();
              $("#pitTemperatureChart").show();
            } else {
              $("#pitTemperatureChart").hide();
            }

            var probe1TemperatureHasData = historicalDataKeys.filter(d => historicalData[d].probe1Temperature != 400).length > 0;
            var probe2TemperatureHasData = historicalDataKeys.filter(d => historicalData[d].probe2Temperature != 400).length > 0;
            var probe3TemperatureHasData = historicalDataKeys.filter(d => historicalData[d].probe3Temperature != 400).length > 0;
            if( probe1TemperatureHasData || probe2TemperatureHasData || probe3TemperatureHasData  ) {
              foodTemperatureChart.data = getFoodTemperatureData(probe1TemperatureHasData, probe2TemperatureHasData, probe3TemperatureHasData);
              foodTemperatureChart.update();
              $("#foodTemperatureChart").show();
            } else {
              $("#foodTemperatureChart").hide();
            }
          },
          draw: function(){
            const pitTemperatureChartElement = document.getElementById("pitTemperatureChart").getContext('2d');
            pitTemperatureChart = new Chart(pitTemperatureChartElement, {
              type: 'line',
              data: getPitTemperatureData(),
              options: {
                responsive: true,
                animation: false,
                legend: {
                  position: "bottom",
                },
                scales: {
                  x: {
                    type: 'time',
                    position: 'bottom',
                    time: {
                      minUnit: 'second'
                    },
                  },
                  y: {
                    min: 0,
                  },
                }
              },
            });
            const foodTemperatureChartElement = document.getElementById("foodTemperatureChart").getContext('2d');
            foodTemperatureChart = new Chart(foodTemperatureChartElement, {
              type: 'line',
              data: getFoodTemperatureData(),
              options: {
                responsive: true,
                animation: false,
                legend: {
                  position: "bottom",
                },
                scales: {
                  x: {
                    type: 'time',
                    position: 'bottom',
                    time: {
                      minUnit: 'second'
                    },
                  },
                  y: {
                    min: 0,
                  },
                }
              },
            });
          }
        }
      })();
    </script>
    <script type="text/javascript">
      /**
      * Utilities to manage the configuration.
      */
      const config = (function(){
        var temperatureUnit = {
            celsius: 1,
            fahrenheit: 2,
        };

        return {
          setRefreshPeriod: function(period){
            if( period == undefined ){
              return;
            }
            Cookies.set("ikamand.period", period, { expires: 365*10 });
          },
          getRefreshPeriod: function(){
            var period = Cookies.get("ikamand.period");
            return period;
          },
          getDefaultRefreshPeriod: function(){
            return 5;
          },
          setTargetFoodTemperature: function(targetFoodTemperature){
            if( targetFoodTemperature == undefined ){
              return;
            }
            Cookies.set("ikamand.targetFoodTemperature", targetFoodTemperature, { expires: 365 * 10});
          },
          getTargetFoodTemperature: function(){
            var targetFoodTemperature = Cookies.get("ikamand.targetFoodTemperature");
            return targetFoodTemperature;
          },
          getDefaultTargetFoodTemperature: function(){
            return 60;
          },
          setTargetPitTemperature: function(targetPitTemperature){
            if( targetPitTemperature == undefined ){
              return;
            }
            Cookies.set("ikamand.targetPitTemperature", targetPitTemperature, { expires: 365 * 10});
          },
          getTargetPitTemperature: function(){
            var targetPitTemperature = Cookies.get("ikamand.targetPitTemperature");
            return targetPitTemperature;
          },
          getDefaultTargetPitTemperature: function(){
            return 110;
          },
          temperatureUnit,
          setTemperatureUnit: function(temperatureUnit){
            if( temperatureUnit == undefined ){
              return;
            }
            Cookies.set("ikamand.temperatureUnit", temperatureUnit, { expires: 365 * 10});
          },
          getTemperatureUnit: function(){
            var temperatureUnit = Cookies.get("ikamand.temperatureUnit");
            return temperatureUnit;
          },
          getDefaultTemperatureUnit: function(){
            return temperatureUnit.celsius;
          },
        }
      })();
    </script>
    <script type="text/javascript">
      /**
      * Utilities to connect to ikamand.
      */
      const ikamand = (function(){
        var lastData = undefined;
        var historicalData = JSON.parse(sessionStorage.getItem("historicalData")) ?? {};

        const pushDataIntoHistory = function(d){
          const currentTime = new Date().getTime();
          historicalData[currentTime] = d;

          // dataset compaction
          // if there are more than X data points, remove some of them
          const timestamps = Object.keys(historicalData);
          if( timestamps.length > 512){
            historicalData = timestamps.filter((t,i) => i%2!=0).reduce((obj, key) => {
                obj[key] = historicalData[key];
                return obj;
              },
              {}
            );
          }

          updateHistoricalData(historicalData);
        }

        const updateHistoricalData = function( h ){
          historicalData = h;
          sessionStorage.setItem("historicalData", JSON.stringify(h));
        }

        const convertToObject = function (input) {
          const output = {};
          input.split('&').forEach((line) => {
            if (line) {
              const [key, value] = line.split('=');
              output[key] = value;
            }
          });
          return output;
        }

        const decodeData = function (rawText){
          const input = convertToObject(rawText);
          const output = {
            time: input['time'],
            rm: input['rm'],
            active: input['acs'],
            session_id: input['csid'],
            cm: input['cm'],
            ag: input['ag'],
            as: input['as'],
            currentPitTemperature: input['pt'],
            probe1Temperature: input['t1'],
            probe2Temperature: input['t2'],
            probe3Temperature: input['t3'],
            fanSpeed: input['dc'],
            targetPitTemperature: input['tpt'],
          };
          return output;
        }

        const fetchAndDecodeData = function (url, options){
          return fetchData(url, options).then(response => {
             // console.log(response);
             const obj = decodeData(response);
             return obj;
          });
        }

        const fetchData = function(url, options) {
          const refreshPeriod = config.getRefreshPeriod() ?? config.getDefaultRefreshPeriod();
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), refreshPeriod * 1000 );

          options = {
            ...options,
            signal: controller.signal
          };

          return fetch(url, options).then(response => {
            if (!response.ok) {
              throw new Error("Request failed");
            }
            return response.text();
          }).then((response) => {
            return response;
          }).catch((error) => {
            console.log(error);
            return null;
          });
        }

        const getFullUrl = function(path) {
          return `/cgi-bin/${path}`;
        }

        return {
          getData: function(){
            lastData = fetchAndDecodeData(getFullUrl("data"));
            lastData.then(d => pushDataIntoHistory(d));
            return lastData;
          },
          stop: function(){
            const payload = new URLSearchParams();
            payload.set('acs', '0');
            payload.set('ag', '0');
            payload.set('csid', '');
            payload.set('sce', '0');
            payload.set('sge', '0');
            payload.set('as', '0');

            const headers = {
             'Content-Type': 'application/x-www-form-urlencoded',
            };

            return fetchAndDecodeData(getFullUrl("cook"), {
              method: 'POST',
              body: payload,
              headers: headers,
            })
          },
          start: function(targetPitTemperature, targetFoodTemperature){
            var currentTime = Math.round(new Date().getTime()/1000);

            const payload = new URLSearchParams();
            payload.set('acs', '1');
            payload.set('csid', crypto.randomUUID());
            payload.set('tpt', targetPitTemperature);
            // activate for 6h, manually disable if needed
            payload.set('sce', currentTime + 24*60*60);
            payload.set('p', '1');
            payload.set('tft', targetFoodTemperature);
            payload.set('as', '0');
            payload.set('ct', currentTime);

            const headers = {
              'Content-Type': 'application/x-www-form-urlencoded',
            };

            return fetchAndDecodeData(getFullUrl("cook"), {
              method: 'POST',
              body: payload,
              headers: headers,
            });
          },
          lastData: function(){
            return lastData;
          },
          getHistoricalData: function(){
            return historicalData;
          },
          clearHistoricalData: function(){
            updateHistoricalData({});
          }
        };
      })();
    </script>
    <script type="text/javascript">
      /**
      * Utilities to manage the information displayed.
      */
      const display = (function(){

        const refresh = function(){
          ikamand.getData().then(d => {
            $("#displayStatus").html(d.active == 0 ? "off" : "on");
            $("#displayTargetPitTemperature").html(convertToTemperatureUnit(d.targetPitTemperature));
            $("#displayCurrentPitTemperature").html(d.currentPitTemperature == 400 ? "-" : convertToTemperatureUnit(d.currentPitTemperature));
            $("#displayProbe1Temperature").html(d.probe1Temperature == 400 ? "-" : convertToTemperatureUnit(d.probe1Temperature));
            $("#displayProbe2Temperature").html(d.probe2Temperature == 400 ? "-" : convertToTemperatureUnit(d.probe2Temperature));
            $("#displayProbe3Temperature").html(d.probe3Temperature == 400 ? "-" : convertToTemperatureUnit(d.probe3Temperature));
            $("#displayFanSpeed").html(d.fanSpeed);

            var updateProbeVisibility = function(id, temperature){
              if( temperature == 400 ){
                $(id).hide();
                return false;
              } else {
                $(id).show();
                return true;
              }
            };

            var probe1TemperatureHasData = updateProbeVisibility("#displayProbe1Group", d.probe1Temperature);
            var probe2TemperatureHasData = updateProbeVisibility("#displayProbe2Group", d.probe2Temperature);
            var probe3TemperatureHasData = updateProbeVisibility("#displayProbe3Group", d.probe3Temperature);

            if( probe1TemperatureHasData || probe2TemperatureHasData || probe3TemperatureHasData){
              $('#displayTargetFoodTemperatureGroup').show();
            } else {
              $('#displayTargetFoodTemperatureGroup').hide();
            }
          });
        };

        var convertToTemperatureUnit = function(temperature){
          var temperatureUnit = config.getTemperatureUnit() ?? config.getDefaultTemperatureUnit();
          if( temperatureUnit == config.temperatureUnit.celsius ){
            return temperature;
          } else if( temperatureUnit == config.temperatureUnit.fahrenheit){
            return Math.round(temperature * 1.8 + 32);
          } else {
            throw Exception(`Unsupported temperature '${temperatureUnit}'`);
          }
        }

        return {
          refresh,
          forcedRefresh: function(){
            for(i=100 ; i<1000 ; i=i+100){
              setTimeout(refresh, i);
            }
          },
          updateTargetFoodTemperature: function(targetFoodTemperature){
            if( targetFoodTemperature == undefined ){
               targetFoodTemperature = config.getTargetFoodTemperature() ?? config.getDefaultTargetFoodTemperature();
            }
            $("#displayTargetFoodTemperature").html(convertToTemperatureUnit(targetFoodTemperature));
            $("#configTargetFoodTemperatureRange").val(convertToTemperatureUnit(targetFoodTemperature));
            $("#configTargetFoodTemperatureRange").prop('min', 0);
            $("#configTargetFoodTemperatureRange").prop('max', convertToTemperatureUnit(380));
            $("#configTargetFoodTemperatureVal").html(convertToTemperatureUnit(targetFoodTemperature));

          },
          updateTargetPitTemperature: function(targetPitTemperature){
            if( targetPitTemperature == undefined ){
               targetPitTemperature = config.getTargetPitTemperature() ?? config.getDefaultTargetPitTemperature();
            }
            $("#configTargetPitTemperatureRange").val(convertToTemperatureUnit(targetPitTemperature));
            $("#configTargetPitTemperatureRange").prop('min', 0);
            $("#configTargetPitTemperatureRange").prop('max', convertToTemperatureUnit(380));
            $("#configTargetPitTemperatureVal").html(convertToTemperatureUnit(targetPitTemperature));
          },
          updateTemperatureUnit: function(temperatureUnit){
            if( temperatureUnit == undefined ){
               temperatureUnit = config.getTemperatureUnit() ?? config.getDefaultTemperatureUnit();
            }
            $("#configTemperatureUnitCelsius").prop('checked', temperatureUnit == config.temperatureUnit.celsius);
            $("#configTemperatureUnitFahrenheit").prop('checked', temperatureUnit == config.temperatureUnit.fahrenheit);
            $(".display-temperature-unit").html( temperatureUnit == config.temperatureUnit.celsius ? "ยบC" : (temperatureUnit == config.temperatureUnit.fahrenheit ? "ยบ F": "") );
          },
          convertToTemperatureUnit,
          convertFromTemperatureUnit: function(temperature){
            var temperatureUnit = config.getTemperatureUnit() ?? config.getDefaultTemperatureUnit();
            if( temperatureUnit == config.temperatureUnit.celsius ){
              return temperature;
            } else if( temperatureUnit == config.temperatureUnit.fahrenheit){
              return Math.round((temperature - 32) / 1.8);
            } else {
              throw Exception(`Unsupported temperature '${temperatureUnit}'`);
            }
          },
          updateRefreshPeriod: function(refreshPeriod){
            if( refreshPeriod == undefined ){
              refreshPeriod = config.getRefreshPeriod() ?? config.getDefaultRefreshPeriod();
            }
            $("#refreshPeriodRange").val(refreshPeriod);
            $("#refreshPeriodVal").html(refreshPeriod);
          },
        }
      })();
    </script>
    <script type="text/javascript">
      /**
      * Start the controller.
      */
      $(window).load(function(){
        display.updateTargetFoodTemperature();
        display.updateTargetPitTemperature();
        display.updateTemperatureUnit();
        display.updateRefreshPeriod();
        display.updateTemperatureUnit();

        $("#configSave").click(function(){
          config.setRefreshPeriod($("#refreshPeriodRange").val());
          config.setTemperatureUnit($("#configTemperatureUnitCelsius").is(":checked") ? config.temperatureUnit.celsius : ($("#configTemperatureUnitFahrenheit").is(":checked") ? config.temperatureUnit.fahrenheit : config.temperatureUnit.celsius  ));

          display.updateTargetFoodTemperature();
          display.updateTargetPitTemperature();
          display.updateTemperatureUnit();
          display.updateRefreshPeriod();
          display.updateTemperatureUnit();

          display.refresh();
          chart.refresh();
          $("#configModal").modal('hide');
        });

        $("#targetFoodTemperatureSave").click(function(){
          targetFoodTemperature = display.convertFromTemperatureUnit($("#configTargetFoodTemperatureRange").val());
          config.setTargetFoodTemperature(targetFoodTemperature);
          display.updateTargetFoodTemperature(targetFoodTemperature);
          $("#targetFoodTemperatureModal").modal('hide');
        });

        $("#targetPitTemperatureSave").click(function(){
          targetPitTemperature = display.convertFromTemperatureUnit($("#configTargetPitTemperatureRange").val());
          config.setTargetPitTemperature(targetPitTemperature);
          ikamand.start(targetPitTemperature, config.getTargetFoodTemperature() ?? config.getDefaultTargetFoodTemperature());
          display.forcedRefresh();
          $("#targetPitTemperatureModal").modal('hide');
        });

        $("#configStatus").click(function(){
          var lastData = ikamand.lastData();
          if( lastData != undefined ){
            ikamand.lastData().then(d=>{
              if(d.active == 0 && d.targetPitTemperature == 0 ){
                $("#targetPitTemperatureModal").modal("show");
              } else {
                d.active==0 ? ikamand.start(d.targetPitTemperature, config.getTargetFoodTemperature() ?? config.getDefaultTargetFoodTemperature()) : ikamand.stop();
                display.forcedRefresh();
              }
            });
          }
        });

        $("#clearHistory").click(function(){
          ikamand.clearHistoricalData();
          chart.refresh();
        });

        display.refresh();
        chart.draw();
        setInterval(function(){display.refresh(); chart.refresh();}, (config.getRefreshPeriod() ?? config.getDefaultRefreshPeriod()) * 1000);
      });
    </script>
  </body>
</html>

